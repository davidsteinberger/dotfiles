# Set your Bitwarden item ID here
BW_ITEM_ID="f7a331e1-25b0-414b-a3fe-acf800e4aaa8"

# Check if profile argument is given
if [ -z "$1" ]; then
  echo "Usage: $0 <aws-profile>"
  exit 1
fi

PROFILE="$1"

# Get credentials from Bitwarden (single call to minimize sudo prompts)
BW_ITEM=$(bw get item "$BW_ITEM_ID")
BW_PASSWORD=$(echo "$BW_ITEM" | jq -r '.login.password')
BW_USERNAME=$(echo "$BW_ITEM" | jq -r '.login.username')
BW_TOTP=$(bw get totp "$BW_ITEM_ID")

if [ -z "$BW_PASSWORD" ]; then
  echo "Failed to retrieve password from Bitwarden."
  exit 1
fi

if [ -z "$BW_USERNAME" ]; then
  echo "Failed to retrieve username from Bitwarden."
  exit 1
fi

if [ -z "$BW_TOTP" ]; then
  echo "Failed to retrieve TOTP from Bitwarden."
  exit 1
fi

echo "Starting AWS Azure login for profile: $PROFILE"
echo "TOTP: $BW_TOTP"

# Set environment variables and run expect inline
export AZURE_DEFAULT_USERNAME="$BW_USERNAME"
export AZURE_DEFAULT_PASSWORD="$BW_PASSWORD"

# Create expect script with proper terminal handling
EXPECT_SCRIPT=$(mktemp)
cat > "$EXPECT_SCRIPT" <<'EOF'
#!/usr/bin/expect -f

# Enable proper terminal handling
exp_internal 0
log_user 1
set timeout 30

# Get variables from environment
set profile $env(PROFILE)
set totp $env(BW_TOTP)

# Use xterm-256color for better compatibility
set env(TERM) "xterm-256color"

# Spawn with proper terminal
spawn aws-azure-login --profile $profile

# Handle either TOTP or Role first
expect {
    "Verification Code" {
        send "$totp\r"
        # Now wait for role selection
        expect {
            "Role" {
                interact
                exit 0
            }
            eof {
                exit 0
            }
            timeout {
                exit 1
            }
        }
    }
    "Role" {
        interact
        exit 0
    }
    timeout {
        exit 1
    }
    eof {
        exit 1
    }
}
EOF

chmod +x "$EXPECT_SCRIPT"
PROFILE="$PROFILE" BW_TOTP="$BW_TOTP" "$EXPECT_SCRIPT"
rm -f "$EXPECT_SCRIPT"

unset AZURE_DEFAULT_USERNAME
unset AZURE_DEFAULT_PASSWORD
