bw() {
  bw_exec=$(sh -c "which bw")
  local bw_session  

  _read_token_from_file() {
    local -r err_token_not_found="Token not found, please run bw --regenerate-session-key"
    case $1 in
    '--force')
      unset bw_session
      ;;
    esac

    if [ "$bw_session" = "$err_token_not_found" ]; then
      unset bw_session
    fi

    if [ -z "$bw_session" ]; then
      bw_session="$(sudo security find-generic-password -a root -s BW_SESSION -w 2>/dev/null)"

      if [ $? -ne 0 ]; then
        echo "$err_token_not_found"
        sudo --reset-timestamp
        return 1
      fi

      sudo --reset-timestamp
    fi
  }

  case $1 in
  '--regenerate-session-key')
    sudo security delete-generic-password -a root -s BW_SESSION 2>/dev/null
    echo "Regenerating session key, this has invalidated all existing sessions..."
    ${bw_exec} logout 2>/dev/null

    new_session=$(${bw_exec} login "${BW_USER}" --raw)
    sudo security add-generic-password -U -a root -s BW_SESSION -w "${new_session}"

    _read_token_from_file --force
    sudo --reset-timestamp
    ;;

  'login' | 'logout' | 'config')
    ${bw_exec} "$@"
    ;;

  '--help' | '-h' | '')
    ${bw_exec} "$@"
    echo "To regenerate your session key type:"
    echo "  bw --regenerate-session-key"
    ;;

  *)
    _read_token_from_file

    ${bw_exec} "$@" --session "$bw_session"
    ;;
  esac
}

bw "$@"
